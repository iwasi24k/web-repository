name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  review:
    if: >
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.title, '[skip ai]')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      OPENAI_MODEL: gpt-5-mini
      MAX_DIFF_SIZE: 200000
      MAX_COMMENT_SIZE: 60000

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Prepare diff
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          git fetch origin $BASE_BRANCH
          git diff origin/$BASE_BRANCH..HEAD > diff.txt

          if [ ! -s diff.txt ]; then
            echo "No diff found. Skip AI review."
            exit 0
          fi

          if [ $(wc -c < diff.txt) -gt $MAX_DIFF_SIZE ]; then
            echo "Diff too large, skipping AI review."
            echo "DIFF_SKIPPED=true" >> $GITHUB_ENV
          else
            echo "DIFF_FILE=diff.txt" >> $GITHUB_ENV
          fi

      - name: Check if diff was skipped
        run: |
          if [ "${DIFF_SKIPPED}" = "true" ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "AIレビューは差分が大きすぎるためスキップされました。"
            exit 0
          fi

      - name: Create payload
        run: |
          SYSTEM_PROMPT="あなたはシニアソフトウェアエンジニアです。  
          以下のプルリクエストは Tailwind CSS v4 を使用した React + TypeScript プロジェクトです。  
          Tailwind v4 の最新仕様に基づき、コードの問題点・改善点・潜在的なバグを簡潔に指摘してください。"
          jq -n --rawfile user "$DIFF_FILE" \
            --arg model "$OPENAI_MODEL" \
            --arg system "$SYSTEM_PROMPT" \
            '{model:$model,messages:[{role:"system",content:$system},{role:"user",content:$user}]}' \
            > payload.json

      - name: Call OpenAI API with backoff
        run: |
          RETRIES=5
          BACKOFF=2
          for i in $(seq 1 $RETRIES); do
            HTTP_STATUS=$(curl -sS --max-time 120 \
              -X POST "https://api.openai.com/v1/chat/completions" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -o response.json \
              -w "%{http_code}" \
              -d @payload.json)

            if [ "$HTTP_STATUS" -eq 200 ]; then
              break
            fi

            echo "Attempt $i failed (HTTP $HTTP_STATUS), retrying in $BACKOFF seconds..."
            sleep $BACKOFF
            BACKOFF=$((BACKOFF*2))
          done

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "OpenAI API request failed after $RETRIES attempts (HTTP $HTTP_STATUS)"
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "AIレビューが失敗しました（HTTP $HTTP_STATUS）。"
            exit 0
          fi

      - name: Extract review
        run: |
          REVIEW=$(jq -r '.choices | if length>0 then map(.message.content) | join("\n\n") else empty end' response.json)
          if [ -z "$REVIEW" ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "AIレビューが空のためコメントできませんでした。"
            exit 0
          fi
          echo "$REVIEW" > review.txt

      - name: Comment PR (split if too long)
        run: |
          if [ $(wc -c < review.txt) -gt $MAX_COMMENT_SIZE ]; then
            echo "Review too long, splitting into multiple comments..."
            split -b $MAX_COMMENT_SIZE review.txt review_part_
            for f in review_part_*; do
              gh pr comment ${{ github.event.pull_request.number }} --body-file $f
            done
          else
            gh pr comment ${{ github.event.pull_request.number }} --body-file review.txt
          fi
